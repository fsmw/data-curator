{% extends "base.html" %}
{% block content %}
<div x-data="searchForm()">
  <div class="card p-3 mb-3">
    <div class="row g-2 align-items-center">
      <div class="col-md-8">
        <input
          x-model="query"
          class="form-control"
          id="search-query"
          placeholder="Buscar indicadores (ej: salarios, tax, inflation, poverty)"
          @keyup.enter="performSearch()"
        />
      </div>
      <div class="col-md-2">
        <select class="form-select" x-model="source">
          <option value="">Fuente</option>
          <option value="owid">Our World in Data</option>
          <option value="ilostat">ILOSTAT</option>
          <option value="oecd">OECD</option>
          <option value="imf">IMF</option>
          <option value="worldbank">World Bank</option>
          <option value="eclac">ECLAC</option>
        </select>
      </div>
      <div class="col-md-2 text-end">
        <button
          @click="performSearch()"
          class="btn btn-primary w-100"
          :disabled="loading"
        >
          <span x-show="!loading"><i class="bi bi-search"></i> Buscar</span>
          <span x-show="loading" class="spinner-border spinner-border-sm me-2"></span>
        </button>
      </div>
    </div>
  </div>
  <div class="card p-3">
  <div class="text-secondary small mb-2">
    <span x-text="results.length"></span> Resultados
    <span x-show="query || source">
      para: <strong x-text="`${query}${source ? ' ‚Ä¢ ' + source : ''}`"></strong>
    </span>
    <!-- Show breakdown of local vs remote results -->
    <span x-show="searchMetadata && searchMetadata.sources" class="ms-3">
      <span class="badge bg-secondary">
        Local: <span x-text="searchMetadata?.sources?.local || 0"></span>
      </span>
      <span class="badge bg-info ms-1" x-show="searchMetadata?.sources?.owid">
        OWID API: <span x-text="searchMetadata?.sources?.owid || 0"></span>
      </span>
      <span class="badge bg-info ms-1" x-show="searchMetadata?.sources?.oecd">
        OECD: <span x-text="searchMetadata?.sources?.oecd || 0"></span>
      </span>
    </span>
  </div>
  <!-- Debug info -->
  <div x-show="results.length > 0" class="alert alert-info small mb-2">
    <strong>Debug:</strong> Received <span x-text="results.length"></span> results. First result ID: <span x-text="results[0]?.id"></span>
  </div>
  <div x-show="successMessage" class="alert alert-success mb-3" role="alert">
    <i class="bi bi-check-circle"></i>
    <span x-text="successMessage"></span>
  </div>
  <div x-show="error" class="alert alert-warning mb-3" role="alert">
    <i class="bi bi-exclamation-triangle"></i>
    <span x-text="error"></span>
  </div>
  <table class="table table-hover align-middle mb-0">
    <thead>
      <tr><th>Indicador</th><th>Descripci√≥n</th><th>Fuente</th><th></th></tr>
    </thead>
    <tbody>
      <template x-for="(result, index) in results" :key="result.id || index">
        <tr>
          <td>
            <strong x-text="result.indicator || 'N/A'"></strong>
            <div class="small text-secondary" x-show="result.tags">
              <i class="bi bi-tag"></i> <span x-text="result.tags"></span>
            </div>
          </td>
          <td class="small text-secondary" x-text="result.description || ''"></td>
          <td>
            <span class="badge bg-primary" x-text="result.source || 'N/A'"></span>
            <!-- Show remote badge for API results -->
            <template x-if="result.remote">
              <span class="badge bg-info ms-1" title="From external API">
                <i class="bi bi-cloud"></i> API
              </span>
            </template>
          </td>
          <td class="text-end">
            <div class="action-buttons d-flex align-items-center gap-2">
              <!-- Downloaded badge -->
              <span x-show="result.downloaded" class="badge bg-success">
                <i class="bi bi-check-circle"></i> Ya Descargado
              </span>
              
              <!-- Remote OWID: Preview button -->
              <button
                x-show="result.remote && (result.source === 'OWID' || result.source?.includes('OWID'))"
                @click.prevent="previewRemote(result)"
                class="btn btn-outline-secondary btn-sm"
                type="button"
                title="Ver gr√°fico PNG desde OWID"
              >
                <i class="bi bi-image"></i>
              </button>

              <!-- Remote OWID: Download button -->
              <button 
                x-show="result.remote && (result.source === 'OWID' || result.source?.includes('OWID'))"
                @click.prevent="startDownload(result)" 
                class="btn btn-outline-primary btn-sm"
                type="button"
                :disabled="downloading[result.id] === true"
                title="Descargar datos CSV de OWID"
              >
                <i x-show="!downloading[result.id]" class="bi bi-download"></i>
                <i x-show="downloading[result.id]" class="bi bi-arrow-repeat"></i>
              </button>
              
              <!-- Remote OWID: Link to website -->
              <a 
                x-show="result.remote && (result.source === 'OWID' || result.source?.includes('OWID'))"
                :href="'https://ourworldindata.org/grapher/' + (result.slug || '')"
                target="_blank"
                class="btn btn-link btn-sm"
                title="Ver en Our World in Data"
              >
                <i class="bi bi-box-arrow-up-right"></i>
              </a>
              
               <!-- Local download button -->
               <button 
                 x-show="!result.remote"
                 @click.prevent="startDownload(result)" 
                 class="btn btn-outline-primary btn-sm"
                 type="button"
                 :disabled="downloading[result.id] === true"
                 title="Descargar datos CSV"
               >
                 <i x-show="!downloading[result.id]" class="bi bi-download"></i>
                 <i x-show="downloading[result.id]" class="bi bi-arrow-repeat"></i>
               </button>
               
               <!-- View versions in Browse Local -->
               <button
                 class="btn btn-outline-secondary btn-sm"
                 @click.prevent="openBrowseVersions(result)"
                 title="View versions in Browse Local"
               >
                 <i class="bi bi-clock-history"></i>
               </button>

              
              <!-- Remote non-OWID download button -->
              <button 
                x-show="result.remote && !(result.source === 'OWID' || result.source?.includes('OWID'))"
                @click.prevent="startDownload(result)" 
                class="btn btn-outline-primary btn-sm"
                type="button"
                :disabled="downloading[result.id] === true"
                title="Descargar datos CSV desde API"
              >
                <i x-show="!downloading[result.id]" class="bi bi-download"></i>
                <i x-show="downloading[result.id]" class="bi bi-arrow-repeat"></i>
              </button>
            </div>
          </td>
        </tr>
      </template>
      <tr x-show="results.length === 0 && !loading">
        <td colspan="4" class="text-center text-secondary py-4">
          <span x-show="!query && !source">Escribe algo para buscar...</span>
          <span x-show="(query || source) && results.length === 0">Sin resultados</span>
        </td>
      </tr>
    </tbody>
  </table>
  </div>
</div>

<!-- Preview Modal - PNG from OWID -->
<div class="modal fade" id="owidPreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="owidPreviewTitle" class="modal-title">üìä Gr√°fico OWID</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <div class="modal-body text-center">
        <!-- Loading spinner -->
        <div id="owidPreviewSpinner" class="py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <div class="text-secondary small mt-2">Cargando gr√°fico...</div>
        </div>
        
        <!-- Error message -->
        <div id="owidPreviewError" class="alert alert-warning d-none" role="alert"></div>
        
        <!-- PNG Image -->
        <img id="owidPreviewImage" src="" alt="OWID Chart" style="max-width: 100%; height: auto; display: none;" />
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <a id="downloadChartLink" href="#" class="btn btn-primary" download>
          <i class="bi bi-download"></i> Descargar PNG
        </a>
      </div>
    </div>
  </div>
</div>
    </div>
  </div>
</div>



<script>
function searchForm() {
  return {
    query: '',
    source: '',
    results: [],
    searchMetadata: null,
    loading: false,
    error: '',
    downloading: {},
    successMessage: '',
    currentSlug: '',

    async performSearch() {
      if (!this.query && !this.source) {
        this.results = [];
        this.searchMetadata = null;
        return;
      }
      this.loading = true;
      this.error = '';
      this.successMessage = '';
      try {
        const params = new URLSearchParams();
        if (this.query) params.append('q', this.query);
        if (this.source) params.append('source', this.source);
        
        const res = await fetch(`/api/search?${params}`);
        if (!res.ok) throw new Error(`Error ${res.status}`);
        const data = await res.json();
        this.results = data.results || [];
        
        // DEBUG: Log first 3 results to see structure
        console.log('First 3 results:', this.results.slice(0, 3).map(r => ({
          id: r.id,
          indicator: r.indicator,
          source: r.source,
          remote: r.remote,
          slug: r.slug
        })));
        
        this.searchMetadata = {
          total: data.total,
          query: data.query,
          sources: data.sources || {}
        };
        console.log('Search complete:', this.searchMetadata);
      } catch (err) {
        this.error = `B√∫squeda fall√≥: ${err.message}`;
        this.results = [];
        this.searchMetadata = null;
      } finally {
        this.loading = false;
      }
    },

    async previewRemote(result) {
      const modalEl = document.getElementById('owidPreviewModal');
      const modal = new bootstrap.Modal(modalEl);
      
      // Show spinner, hide content
      document.getElementById('owidPreviewSpinner').classList.remove('d-none');
      document.getElementById('owidPreviewError').classList.add('d-none');
      document.getElementById('owidPreviewImage').style.display = 'none';
      document.getElementById('owidPreviewTitle').textContent = result.slug || result.indicator || 'Gr√°fico';
      
      modal.show();

      try {
        const slug = result.slug || result.id;
        if (!slug) throw new Error('No slug disponible');

        // Load PNG directly
        const pngUrl = `/api/chart/export-png?slug=${encodeURIComponent(slug)}`;
        
        // Verify the image loads
        const img = new Image();
        img.onload = () => {
          document.getElementById('owidPreviewSpinner').classList.add('d-none');
          document.getElementById('owidPreviewImage').src = pngUrl;
          document.getElementById('owidPreviewImage').style.display = 'block';
          
          // Set download link
          const downloadBtn = document.getElementById('downloadChartLink');
          downloadBtn.href = pngUrl;
          downloadBtn.download = `${slug}.png`;
        };
        
        img.onerror = () => {
          throw new Error('No se pudo cargar el gr√°fico');
        };
        
        img.src = pngUrl;
        this.currentSlug = slug;
        
      } catch (err) {
        console.error('Preview error', err);
        document.getElementById('owidPreviewSpinner').classList.add('d-none');
        const errEl = document.getElementById('owidPreviewError');
        errEl.textContent = err.message || String(err);
        errEl.classList.remove('d-none');
      }
    },

    async startDownload(result) {
      console.log('=== DOWNLOAD STARTED ===');
      this.downloading = { ...this.downloading, [result.id]: true };
      this.error = '';
      this.successMessage = '';

      try {
        const res = await fetch('/api/download/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            id: result.id, 
            source: result.source.toLowerCase(), 
            indicator: result.indicator, 
            description: result.description, 
            remote: result.remote || false, 
            slug: result.slug, 
            url: result.url 
          })
        });

        let data;
        try {
          data = await res.json();
        } catch (parseErr) {
          const text = await res.text().catch(() => null);
          if (text) {
            this.error = text;
          } else {
            this.error = 'Invalid response from server';
          }
          return;
        }

        // Rely on consistent backend JSON: status = success|enqueued|already_queued|error
        if (data.status === 'success') {
          this.successMessage = data.message || `‚úì Descarga completada: ${result.indicator}`;
          const resultIndex = this.results.findIndex(r => r.id === result.id);
          if (resultIndex !== -1) { this.results[resultIndex].downloaded = true; }
          setTimeout(() => { this.successMessage = ''; }, 5000);
        } else if (data.status === 'enqueued') {
          this.successMessage = data.message || `‚úì Descarga en cola para "${result.indicator}".`;
          setTimeout(() => { this.successMessage = ''; }, 5000);
        } else if (data.status === 'already_queued') {
          this.error = data.message || 'Este indicador ya est√° en la cola de descargas.';
        } else {
          this.error = data.message || data.error || `Error desconocido (status: ${data.status})`;
        }

      } catch (err) {
        this.error = `Error al iniciar descarga: ${err.message}`;
        console.error('Download error:', err);
      } finally {
        this.downloading = { ...this.downloading, [result.id]: false };
      }
    },

    openBrowseVersions(result) {
      // Prefer passing slug/id to browse local
      const identifier = result.slug || result.id || result.indicator;
      const source = (result.source || '').toLowerCase();
      // Open browse local with query params to show latest and prefill search
      const url = `/browse/local?q=${encodeURIComponent(identifier)}&latest=true&source=${encodeURIComponent(source)}`;
      window.location.href = url;
    }
  };
}
</script>
{% endblock %}
