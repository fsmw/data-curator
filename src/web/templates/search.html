{% extends "base.html" %}
{% block content %}
<div x-data="searchForm()">
  <!-- Search Box -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-lg-7 col-md-6">
          <label class="form-label">Search Indicators</label>
          <div class="search-wrapper">
            <i class="bi bi-search"></i>
            <input
              x-model="query"
              class="form-control search-input"
              id="search-query"
              placeholder="Search by keyword (e.g., GDP, inflation, unemployment)"
              @keyup.enter="performSearch()"
            />
          </div>
        </div>
        <div class="col-lg-3 col-md-4">
          <label class="form-label">Data Source</label>
          <select class="form-select" x-model="source">
            <option value="">All Sources</option>
            <option value="owid">Our World in Data</option>
            <option value="ilostat">ILOSTAT</option>
            <option value="oecd">OECD</option>
            <option value="imf">IMF</option>
            <option value="worldbank">World Bank</option>
            <option value="eclac">ECLAC</option>
          </select>
        </div>
        <div class="col-lg-2 col-md-2">
          <button
            @click="performSearch()"
            class="btn btn-primary w-100"
            :disabled="loading"
          >
            <span x-show="!loading"><i class="bi bi-search"></i> Search</span>
            <span x-show="loading"><span class="spinner-border spinner-border-sm me-1"></span> Searching...</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Section -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <span class="text-gold fw-semibold" x-text="results.length"></span>
        <span class="text-secondary"> Results</span>
        <span x-show="query || source" class="text-secondary">
          for "<strong class="text-gold" x-text="query"></strong>"
          <span x-show="source"> in <span class="badge badge-source" x-text="source.toUpperCase()"></span></span>
        </span>
      </div>
      <!-- Source breakdown badges -->
      <div x-show="searchMetadata && searchMetadata.sources" class="d-flex gap-2">
        <span class="badge badge-secondary badge-pill">
          <i class="bi bi-hdd me-1"></i>Local: <span x-text="searchMetadata?.sources?.local || 0"></span>
        </span>
        <span class="badge badge-info badge-pill" x-show="searchMetadata?.sources?.owid">
          <i class="bi bi-cloud me-1"></i>OWID: <span x-text="searchMetadata?.sources?.owid || 0"></span>
        </span>
        <span class="badge badge-oecd badge-pill" x-show="searchMetadata?.sources?.oecd">
          OECD: <span x-text="searchMetadata?.sources?.oecd || 0"></span>
        </span>
      </div>
    </div>
    
    <div class="card-body p-0">
      <!-- Success/Error Messages -->
      <div x-show="successMessage" class="alert alert-success m-3" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span x-text="successMessage"></span>
      </div>
      <div x-show="error" class="alert alert-warning m-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span x-text="error"></span>
      </div>
      
      <!-- Results Table -->
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th style="width: 30%">Indicator</th>
            <th style="width: 35%">Description</th>
            <th style="width: 15%">Source</th>
            <th style="width: 20%" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(result, index) in results" :key="result.id || index">
            <tr>
              <td>
                <div class="fw-semibold" x-text="result.indicator || 'N/A'"></div>
                <div class="small text-muted" x-show="result.tags">
                  <i class="bi bi-tags me-1"></i><span x-text="result.tags"></span>
                </div>
              </td>
              <td class="small text-secondary" x-text="result.description || ''"></td>
              <td>
                <span 
                  class="badge badge-pill"
                  :class="{
                    'badge-bcch': result.source?.toLowerCase() === 'bcch',
                    'badge-oecd': result.source?.toLowerCase() === 'oecd',
                    'badge-worldbank': result.source?.toLowerCase() === 'worldbank',
                    'badge-fred': result.source?.toLowerCase() === 'fred',
                    'badge-info': !['bcch','oecd','worldbank','fred'].includes(result.source?.toLowerCase())
                  }"
                  x-text="result.source || 'N/A'"
                ></span>
                <template x-if="result.remote">
                  <span class="badge badge-secondary badge-pill ms-1" title="From external API">
                    <i class="bi bi-cloud-arrow-down"></i>
                  </span>
                </template>
              </td>
              <td class="text-end">
                <div class="action-buttons">
                  <!-- Downloaded badge -->
                  <span x-show="result.downloaded" class="badge badge-success badge-pill me-2">
                    <i class="bi bi-check-circle-fill"></i> Downloaded
                  </span>
                  
                  <!-- Remote OWID: Preview button -->
                  <button
                    x-show="result.remote && (result.source === 'OWID' || result.source?.includes('OWID'))"
                    @click.prevent="previewRemote(result)"
                    class="btn btn-outline-light btn-sm btn-icon"
                    type="button"
                    title="Preview chart"
                  >
                    <i class="bi bi-eye"></i>
                  </button>

                  <!-- Download button (all types) -->
                  <button 
                    @click.prevent="startDownload(result)" 
                    class="btn btn-outline-primary btn-sm"
                    type="button"
                    :disabled="downloading[result.id] === true"
                    title="Download CSV data"
                  >
                    <i x-show="!downloading[result.id]" class="bi bi-download"></i>
                    <span x-show="downloading[result.id]" class="spinner-border spinner-border-sm"></span>
                  </button>
                  
                  <!-- Remote OWID: Link to website -->
                  <a 
                    x-show="result.remote && (result.source === 'OWID' || result.source?.includes('OWID'))"
                    :href="'https://ourworldindata.org/grapher/' + (result.slug || '')"
                    target="_blank"
                    class="btn btn-outline-light btn-sm btn-icon"
                    title="View on Our World in Data"
                  >
                    <i class="bi bi-box-arrow-up-right"></i>
                  </a>
                  
                  <!-- View versions in Browse Local -->
                  <button
                    class="btn btn-outline-light btn-sm btn-icon"
                    @click.prevent="openBrowseVersions(result)"
                    title="View version history"
                  >
                    <i class="bi bi-clock-history"></i>
                  </button>
                </div>
              </td>
            </tr>
          </template>
          
          <!-- Empty State -->
          <tr x-show="results.length === 0 && !loading">
            <td colspan="4" class="text-center py-5">
              <div class="empty-state">
                <i class="bi bi-search"></i>
                <h5 x-show="!query && !source">Start your search</h5>
                <p x-show="!query && !source">Enter keywords to search for economic indicators across multiple data sources.</p>
                <h5 x-show="(query || source)">No results found</h5>
                <p x-show="(query || source)">Try different keywords or select a different data source.</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Preview Modal - PNG from OWID -->
<div class="modal fade" id="owidPreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="owidPreviewTitle" class="modal-title">
          <i class="bi bi-bar-chart-line text-gold me-2"></i>
          Chart Preview
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <div class="modal-body text-center" style="min-height: 300px;">
        <!-- Loading spinner -->
        <div id="owidPreviewSpinner" class="py-5">
          <div class="spinner text-center mx-auto mb-3"></div>
          <div class="text-secondary small">Loading chart from Our World in Data...</div>
        </div>
        
        <!-- Error message -->
        <div id="owidPreviewError" class="alert alert-warning d-none" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <span></span>
        </div>
        
        <!-- PNG Image -->
        <img id="owidPreviewImage" src="" alt="OWID Chart" class="rounded-lg" style="max-width: 100%; height: auto; display: none;" />
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
        <a id="downloadChartLink" href="#" class="btn btn-primary" download>
          <i class="bi bi-download"></i> Download PNG
        </a>
      </div>
    </div>
  </div>
</div>



<script>
function searchForm() {
  return {
    query: '',
    source: '',
    results: [],
    searchMetadata: null,
    loading: false,
    error: '',
    downloading: {},
    successMessage: '',
    currentSlug: '',

    async performSearch() {
      if (!this.query && !this.source) {
        this.results = [];
        this.searchMetadata = null;
        return;
      }
      this.loading = true;
      this.error = '';
      this.successMessage = '';
      try {
        const params = new URLSearchParams();
        if (this.query) params.append('q', this.query);
        if (this.source) params.append('source', this.source);
        
        const res = await fetch(`/api/search?${params}`);
        if (!res.ok) throw new Error(`Error ${res.status}`);
        const data = await res.json();
        this.results = data.results || [];
        
        // DEBUG: Log first 3 results to see structure
        console.log('First 3 results:', this.results.slice(0, 3).map(r => ({
          id: r.id,
          indicator: r.indicator,
          source: r.source,
          remote: r.remote,
          slug: r.slug
        })));
        
        this.searchMetadata = {
          total: data.total,
          query: data.query,
          sources: data.sources || {}
        };
        console.log('Search complete:', this.searchMetadata);
      } catch (err) {
        this.error = `Búsqueda falló: ${err.message}`;
        this.results = [];
        this.searchMetadata = null;
      } finally {
        this.loading = false;
      }
    },

    async previewRemote(result) {
      const modalEl = document.getElementById('owidPreviewModal');
      const modal = new bootstrap.Modal(modalEl);
      
      // Show spinner, hide content
      document.getElementById('owidPreviewSpinner').classList.remove('d-none');
      document.getElementById('owidPreviewError').classList.add('d-none');
      document.getElementById('owidPreviewImage').style.display = 'none';
      document.getElementById('owidPreviewTitle').textContent = result.slug || result.indicator || 'Gráfico';
      
      modal.show();

      try {
        const slug = result.slug || result.id;
        if (!slug) throw new Error('No slug disponible');

        // Load PNG directly
        const pngUrl = `/api/chart/export-png?slug=${encodeURIComponent(slug)}`;
        
        // Verify the image loads
        const img = new Image();
        img.onload = () => {
          document.getElementById('owidPreviewSpinner').classList.add('d-none');
          document.getElementById('owidPreviewImage').src = pngUrl;
          document.getElementById('owidPreviewImage').style.display = 'block';
          
          // Set download link
          const downloadBtn = document.getElementById('downloadChartLink');
          downloadBtn.href = pngUrl;
          downloadBtn.download = `${slug}.png`;
        };
        
        img.onerror = () => {
          throw new Error('No se pudo cargar el gráfico');
        };
        
        img.src = pngUrl;
        this.currentSlug = slug;
        
      } catch (err) {
        console.error('Preview error', err);
        document.getElementById('owidPreviewSpinner').classList.add('d-none');
        const errEl = document.getElementById('owidPreviewError');
        errEl.textContent = err.message || String(err);
        errEl.classList.remove('d-none');
      }
    },

    async startDownload(result) {
      console.log('=== DOWNLOAD STARTED ===');
      this.downloading = { ...this.downloading, [result.id]: true };
      this.error = '';
      this.successMessage = '';

      try {
        const res = await fetch('/api/download/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            id: result.id, 
            source: result.source.toLowerCase(), 
            indicator: result.indicator, 
            description: result.description, 
            remote: result.remote || false, 
            slug: result.slug, 
            url: result.url 
          })
        });

        let data;
        try {
          data = await res.json();
        } catch (parseErr) {
          const text = await res.text().catch(() => null);
          if (text) {
            this.error = text;
          } else {
            this.error = 'Invalid response from server';
          }
          return;
        }

        // Rely on consistent backend JSON: status = success|enqueued|already_queued|error
        if (data.status === 'success') {
          this.successMessage = data.message || `✓ Descarga completada: ${result.indicator}`;
          const resultIndex = this.results.findIndex(r => r.id === result.id);
          if (resultIndex !== -1) { this.results[resultIndex].downloaded = true; }
          setTimeout(() => { this.successMessage = ''; }, 5000);
        } else if (data.status === 'enqueued') {
          this.successMessage = data.message || `✓ Descarga en cola para "${result.indicator}".`;
          setTimeout(() => { this.successMessage = ''; }, 5000);
        } else if (data.status === 'already_queued') {
          this.error = data.message || 'Este indicador ya está en la cola de descargas.';
        } else {
          this.error = data.message || data.error || `Error desconocido (status: ${data.status})`;
        }

      } catch (err) {
        this.error = `Error al iniciar descarga: ${err.message}`;
        console.error('Download error:', err);
      } finally {
        this.downloading = { ...this.downloading, [result.id]: false };
      }
    },

    openBrowseVersions(result) {
      // Prefer passing slug/id to browse local
      const identifier = result.slug || result.id || result.indicator;
      const source = (result.source || '').toLowerCase();
      // Open browse local with query params to show latest and prefill search
      const url = `/browse/local?q=${encodeURIComponent(identifier)}&latest=true&source=${encodeURIComponent(source)}`;
      window.location.href = url;
    }
  };
}
</script>
{% endblock %}
