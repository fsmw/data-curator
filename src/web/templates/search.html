{% extends "base.html" %}
{% block content %}
<div x-data="searchForm()">
  <!-- Search Box -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-lg-7 col-md-6">
          <label class="form-label">Search Indicators</label>
          <div class="search-wrapper">
            <i class="bi bi-search"></i>
            <input x-model="query" class="form-control search-input" id="search-query"
              placeholder="Search by keyword (e.g., GDP, inflation, unemployment)" @keyup.enter="performSearch()" />
          </div>
        </div>
        <div class="col-lg-3 col-md-4">
          <label class="form-label">Data Source</label>
          <select class="form-select" x-model="source">
            <option value="">All Sources</option>
            <option value="owid">Our World in Data</option>
            <option value="ilostat">ILOSTAT</option>
            <option value="oecd">OECD</option>
            <option value="imf">IMF</option>
            <option value="worldbank">World Bank</option>
            <option value="eclac">ECLAC</option>
          </select>
        </div>
        <div class="col-lg-2 col-md-2">
          <button @click="performSearch()" class="btn btn-primary w-100" :disabled="loading">
            <span x-show="!loading"><i class="bi bi-search"></i> Search</span>
            <span x-show="loading"><span class="spinner-border spinner-border-sm me-1"></span> Searching...</span>
          </button>
        </div>
      </div>
    </div>
  </div>


  <!-- Quick Filters -->
  <div class="mb-4">
    <small class="text-uppercase text-muted fw-bold ms-1" style="font-size: 0.7rem;">Quick Filters</small>
    <div class="d-flex flex-wrap gap-2 mt-2">
      <button @click="applyQuickFilter('latam')" class="btn btn-sm btn-outline-secondary rounded-pill">
        üåé LATAM + Spain
      </button>
      <button @click="applyQuickFilter('oecd')" class="btn btn-sm btn-outline-secondary rounded-pill">
        üìä OECD
      </button>
      <button @click="applyQuickFilter('g20')" class="btn btn-sm btn-outline-secondary rounded-pill">
        üåç G20
      </button>
      <button @click="applyQuickFilter('inflation')" class="btn btn-sm btn-outline-danger rounded-pill">
        üìà Inflation > 10%
      </button>
      <button @click="applyQuickFilter('poverty')" class="btn btn-sm btn-outline-warning rounded-pill">
        üìâ Poverty
      </button>
    </div>
  </div>

  <!-- Results Section -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <span class="text-gold fw-semibold" x-text="searchMetadata?.total || results.length"></span>
        <span class="text-secondary"> Results</span>
        <span x-show="query || source" class="text-secondary">
          for "<strong class="text-gold" x-text="query"></strong>"
          <span x-show="source"> in <span class="badge badge-source" x-text="source.toUpperCase()"></span></span>
        </span>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <!-- Source breakdown badges -->
        <div x-show="searchMetadata && searchMetadata.sources" class="d-flex gap-2">
          <span class="badge badge-secondary badge-pill">
            <i class="bi bi-hdd me-1"></i>Local: <span x-text="searchMetadata?.sources?.local || 0"></span>
          </span>
          <span class="badge badge-info badge-pill" x-show="searchMetadata?.sources?.owid">
            <i class="bi bi-cloud me-1"></i>OWID: <span x-text="searchMetadata?.sources?.owid || 0"></span>
          </span>
          <span class="badge badge-oecd badge-pill" x-show="searchMetadata?.sources?.oecd">
            OECD: <span x-text="searchMetadata?.sources?.oecd || 0"></span>
          </span>
        </div>
        <button class="btn btn-outline-primary btn-sm" @click="downloadSelected()"
          :disabled="selectedKeys.length === 0 || bulkDownloading">
          <span x-show="!bulkDownloading"><i class="bi bi-download me-1"></i>Download selected</span>
          <span x-show="bulkDownloading"><span class="spinner-border spinner-border-sm me-1"></span>Downloading...</span>
        </button>
      </div>
    </div>

    <div class="card-body p-0">
      <!-- Success/Error Messages -->
      <div x-show="successMessage" class="alert alert-success m-3" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span x-text="successMessage"></span>
      </div>
      <div x-show="error" class="alert alert-warning m-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span x-text="error"></span>
      </div>

      <!-- Results Table -->
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th style="width: 4%" class="text-center">
                <input class="form-check-input" type="checkbox" aria-label="Select all results"
                  :checked="allSelected()" @change="toggleSelectAll()">
              </th>
              <th style="width: 26%">Indicator</th>
              <th style="width: 35%">Description</th>
              <th style="width: 15%">Source</th>
              <th style="width: 20%" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(result, index) in results" :key="result.id || index">
              <tr>
                <td class="text-center">
                  <input class="form-check-input" type="checkbox" aria-label="Select row"
                    :disabled="!selectionKey(result)"
                    :checked="isSelected(result)" @change="toggleSelection(result)">
                </td>
                <td>
                  <div class="fw-semibold" x-text="result.indicator || 'N/A'"></div>
                  <div class="small text-muted" x-show="result.tags">
                    <i class="bi bi-tags me-1"></i><span x-text="result.tags"></span>
                  </div>
                </td>
                <td class="small text-secondary" x-text="result.description || ''"></td>
                <td>
                  <span class="badge badge-pill" :class="{
                      'badge-bcch': result.source?.toLowerCase() === 'bcch',
                      'badge-oecd': result.source?.toLowerCase() === 'oecd',
                      'badge-worldbank': result.source?.toLowerCase() === 'worldbank',
                      'badge-fred': result.source?.toLowerCase() === 'fred',
                      'badge-info': !['bcch','oecd','worldbank','fred'].includes(result.source?.toLowerCase())
                    }" x-text="result.source || 'N/A'"></span>
                  <template x-if="result.remote">
                    <span class="badge badge-secondary badge-pill ms-1" title="From external API">
                      <i class="bi bi-cloud-arrow-down"></i>
                    </span>
                  </template>
                </td>
                <td class="text-end">
                  <div class="action-buttons">
                    <span x-show="downloadStatus[result.id]" class="badge badge-pill"
                      :class="statusClass(downloadStatus[result.id])"
                      x-text="statusLabel(downloadStatus[result.id])"></span>
                    <!-- Downloaded badge -->
                    <span x-show="result.downloaded" class="badge badge-success badge-pill me-2">
                      <i class="bi bi-check-circle-fill"></i> Downloaded
                    </span>

                    <!-- Remote OWID: Preview button -->
                    <button x-show="result.remote && (result.source || '').toLowerCase().includes('owid')"
                      @click.prevent="previewRemote(result)" class="btn btn-outline-secondary btn-sm btn-icon" type="button"
                      title="Preview chart">
                      <i class="bi bi-eye"></i>
                    </button>

                    <!-- Remote World Bank: Preview button -->
                    <button x-show="result.remote && (result.source || '').toLowerCase().includes('worldbank')"
                      @click.prevent="previewWorldBank(result)" class="btn btn-outline-secondary btn-sm btn-icon" type="button"
                      title="Preview data">
                      <i class="bi bi-eye"></i>
                    </button>

                    <!-- Remote OECD: Preview button -->
                    <button x-show="result.remote && (result.source || '').toLowerCase().includes('oecd')"
                      @click.prevent="previewOecd(result)" class="btn btn-outline-secondary btn-sm btn-icon" type="button"
                      title="Preview data">
                      <i class="bi bi-eye"></i>
                    </button>

                    <!-- Download button (all types) -->
                    <!-- Download/Update button -->
                    <button @click.prevent="startDownload(result)" class="btn btn-sm"
                      :class="result.downloaded ? 'btn-outline-success' : 'btn-outline-primary'"
                      :disabled="downloading[result.id] === true"
                      :title="result.downloaded ? 'Update dataset (re-download)' : 'Download CSV data'">

                      <!-- Spinner -->
                      <span x-show="downloading[result.id]" class="spinner-border spinner-border-sm"></span>

                      <!-- Icons/Text -->
                      <template x-if="!downloading[result.id]">
                        <span>
                          <i x-show="!result.downloaded" class="bi bi-download"></i>
                          <span x-show="result.downloaded">
                            <i class="bi bi-arrow-repeat"></i> Update
                          </span>
                        </span>
                      </template>
                    </button>

                    <!-- Remote OWID: Link to website -->
                    <a x-show="result.remote && (result.source || '').toLowerCase().includes('owid')"
                      :href="'https://ourworldindata.org/grapher/' + (result.slug || '')" target="_blank"
                      class="btn btn-outline-secondary btn-sm btn-icon" title="View on Our World in Data">
                      <i class="bi bi-box-arrow-up-right"></i>
                    </a>

                    <!-- View versions in Browse Local -->
                    <button class="btn btn-outline-secondary btn-sm btn-icon" @click.prevent="openBrowseVersions(result)"
                      title="View version history">
                      <i class="bi bi-clock-history"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </template>

            <!-- Empty State -->
            <tr x-show="results.length === 0 && !loading">
              <td colspan="5" class="text-center py-5">
                <div class="empty-state">
                  <i class="bi bi-search"></i>
                  <h5 x-show="!query && !source">Start your search</h5>
                  <p x-show="!query && !source">Enter keywords to search for economic indicators across multiple data
                    sources.</p>
                  <h5 x-show="(query || source)">No results found</h5>
                  <p x-show="(query || source)">Try different keywords or select a different data source.</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 px-3 py-3 border-top">
        <div class="small text-secondary">
          Showing
          <span x-text="results.length"></span>
          of
          <span x-text="searchMetadata?.total || results.length"></span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <label class="small text-secondary mb-0">Page size</label>
          <select class="form-select form-select-sm" style="width: auto;" x-model.number="perPage"
            @change="setPage(1)">
            <option :value="10">10</option>
            <option :value="25">25</option>
            <option :value="50">50</option>
            <option :value="100">100</option>
          </select>
          <button class="btn btn-outline-secondary btn-sm" @click="prevPage()" :disabled="page <= 1 || loading">
            <i class="bi bi-chevron-left"></i> Prev
          </button>
          <span class="small text-secondary">
            Page <span x-text="page"></span> / <span x-text="totalPages"></span>
          </span>
          <button class="btn btn-outline-secondary btn-sm" @click="nextPage()"
            :disabled="page >= totalPages || loading">
            Next <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal - PNG from OWID -->
<div class="modal fade" id="owidPreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="owidPreviewTitle" class="modal-title">
          <i class="bi bi-bar-chart-line text-gold me-2"></i>
          Chart Preview
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body text-center" style="min-height: 300px;">
        <!-- Loading spinner -->
        <div id="owidPreviewSpinner" class="py-5">
          <div class="spinner text-center mx-auto mb-3"></div>
          <div class="text-secondary small">Loading chart from Our World in Data...</div>
        </div>

        <!-- Error message -->
        <div id="owidPreviewError" class="alert alert-warning d-none" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <span></span>
        </div>

        <!-- PNG Image -->
        <img id="owidPreviewImage" src="" alt="OWID Chart" class="rounded-lg"
          style="max-width: 100%; height: auto; display: none;" />
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <a id="downloadChartLink" href="#" class="btn btn-primary" download>
          <i class="bi bi-download"></i> Download PNG
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal - World Bank (table) -->
<div class="modal fade" id="worldbankPreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="worldbankPreviewTitle" class="modal-title">
          <i class="bi bi-table text-gold me-2"></i>
          Data Preview
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div id="worldbankPreviewSpinner" class="py-4 text-center">
          <div class="spinner text-center mx-auto mb-3"></div>
          <div class="text-secondary small">Loading data from World Bank...</div>
        </div>

        <div id="worldbankPreviewError" class="alert alert-warning d-none" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <span></span>
        </div>

        <div id="worldbankPreviewChart" class="mb-3" style="display: none;">
          <div class="small text-secondary mb-2">Average by year (preview)</div>
          <svg id="worldbankPreviewSvg" width="100%" height="120" viewBox="0 0 360 120" preserveAspectRatio="none"></svg>
        </div>

        <div id="worldbankPreviewTable" class="table-responsive" style="max-height: 400px; overflow: auto; display: none;">
          <table class="table table-sm table-striped mb-0">
            <thead class="sticky-top bg-white">
              <tr>
                <th>Country</th>
                <th>Code</th>
                <th>Year</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody id="worldbankPreviewTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal - OECD (table + mini chart) -->
<div class="modal fade" id="oecdPreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="oecdPreviewTitle" class="modal-title">
          <i class="bi bi-table text-gold me-2"></i>
          Data Preview
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div id="oecdPreviewSpinner" class="py-4 text-center">
          <div class="spinner text-center mx-auto mb-3"></div>
          <div class="text-secondary small">Loading data from OECD...</div>
        </div>

        <div id="oecdPreviewError" class="alert alert-warning d-none" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <span></span>
        </div>

        <div id="oecdPreviewChart" class="mb-3" style="display: none;">
          <div class="small text-secondary mb-2">Average by year (preview)</div>
          <svg id="oecdPreviewSvg" width="100%" height="120" viewBox="0 0 360 120" preserveAspectRatio="none"></svg>
        </div>

        <div id="oecdPreviewTable" class="table-responsive" style="max-height: 400px; overflow: auto; display: none;">
          <table class="table table-sm table-striped mb-0">
            <thead class="sticky-top bg-white">
              <tr>
                <th>Country</th>
                <th>Year</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody id="oecdPreviewTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


</div>
</div>

<script>
  function searchForm() {
    return {
      query: '',
      source: '',
      results: [],
      searchMetadata: null,
      loading: false,
      error: '',
      downloading: {},
      downloadStatus: {},
      successMessage: '',
      currentSlug: '',
      selectedKeys: [],
      bulkDownloading: false,
      page: 1,
      perPage: 25,
      totalPages: 1,

      init() {
        const urlParams = new URLSearchParams(window.location.search);
        const initialQ = urlParams.get('q');
        const initialSource = urlParams.get('source');

        if (initialQ) this.query = initialQ;
        if (initialSource) this.source = initialSource;

        if (this.query || this.source) {
          this.performSearch();
        } else {
          // Default: Load recent results from OWID
          this.loadDefaults();
        }
      },

      async loadDefaults() {
        this.source = 'owid';
        this.query = '20'; // Lighter default query for faster initial load
        this.page = 1;
        await this.performSearch();
      },

      async performSearch() {
        if (!this.query && !this.source) {
          this.results = [];
          this.searchMetadata = null;
          return;
        }
        this.loading = true;
        this.error = '';
        this.successMessage = '';
        try {
          const params = new URLSearchParams();
          if (this.query) params.append('q', this.query);
          if (this.source) params.append('source', this.source);
          params.append('page', this.page);
          params.append('per_page', this.perPage);

          const res = await fetch(`/api/search?${params}`);
          if (!res.ok) throw new Error(`Error ${res.status}`);
          const data = await res.json();
          this.results = data.results || [];
          this.selectedKeys = [];
          this.downloadStatus = {};
          this.totalPages = data.total_pages || 1;

          // DEBUG: Log first 3 results to see structure
          console.log('First 3 results:', this.results.slice(0, 3).map(r => ({
            id: r.id,
            indicator: r.indicator,
            source: r.source,
            remote: r.remote,
            slug: r.slug
          })));

          this.searchMetadata = {
            total: data.total,
            query: data.query,
            sources: data.sources || {}
          };
          console.log('Search complete:', this.searchMetadata);
        } catch (err) {
          this.error = `Search failed: ${err.message}`;
          this.results = [];
          this.searchMetadata = null;
        } finally {
          this.loading = false;
        }
      },

      renderMiniChart(svgId, series) {
        const svg = document.getElementById(svgId);
        if (!svg) return;
        svg.innerHTML = '';

        if (!Array.isArray(series) || series.length < 2) return;

        const points = series
          .map(item => ({ x: Number(item.x), y: Number(item.y) }))
          .filter(item => Number.isFinite(item.x) && Number.isFinite(item.y))
          .sort((a, b) => a.x - b.x);

        if (points.length < 2) return;

        const width = 360;
        const height = 120;
        const pad = 8;
        const minY = Math.min(...points.map(p => p.y));
        const maxY = Math.max(...points.map(p => p.y));
        const range = maxY - minY || 1;
        const step = (width - pad * 2) / (points.length - 1);

        const coords = points.map((p, i) => {
          const x = pad + i * step;
          const y = height - pad - ((p.y - minY) / range) * (height - pad * 2);
          return { x, y };
        });

        const path = coords
          .map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x} ${p.y}`)
          .join(' ');

        svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
        svg.innerHTML = `
          <path d="${path}" fill="none" stroke="#c78f2c" stroke-width="2" />
          <circle cx="${coords[coords.length - 1].x}" cy="${coords[coords.length - 1].y}" r="2.5" fill="#c78f2c" />
        `;
      },

      setPage(nextPage) {
        if (nextPage < 1) return;
        this.page = nextPage;
        this.performSearch();
      },

      nextPage() {
        if (this.page >= this.totalPages) return;
        this.setPage(this.page + 1);
      },

      prevPage() {
        if (this.page <= 1) return;
        this.setPage(this.page - 1);
      },

      async previewRemote(result) {
        const modalEl = document.getElementById('owidPreviewModal');
        const modal = new bootstrap.Modal(modalEl);

        // Show spinner, hide content
        document.getElementById('owidPreviewSpinner').classList.remove('d-none');
        document.getElementById('owidPreviewError').classList.add('d-none');
        document.getElementById('owidPreviewImage').style.display = 'none';
        document.getElementById('owidPreviewTitle').textContent = result.slug || result.indicator || 'Chart';

        modal.show();

        try {
          const slug = result.slug || result.id;
          if (!slug) throw new Error('No slug available');

          // Load PNG directly
          const pngUrl = `/api/chart/export-png?slug=${encodeURIComponent(slug)}`;

          // Verify the image loads
          const img = new Image();
          img.onload = () => {
            document.getElementById('owidPreviewSpinner').classList.add('d-none');
            document.getElementById('owidPreviewImage').src = pngUrl;
            document.getElementById('owidPreviewImage').style.display = 'block';

            // Set download link
            const downloadBtn = document.getElementById('downloadChartLink');
            downloadBtn.href = pngUrl;
            downloadBtn.download = `${slug}.png`;
          };

          img.onerror = () => {
            throw new Error('Could not load chart');
          };

          img.src = pngUrl;
          this.currentSlug = slug;

        } catch (err) {
          console.error('Preview error', err);
          document.getElementById('owidPreviewSpinner').classList.add('d-none');
          const errEl = document.getElementById('owidPreviewError');
          errEl.textContent = err.message || String(err);
          errEl.classList.remove('d-none');
        }
      },

      async previewWorldBank(result) {
        const modalEl = document.getElementById('worldbankPreviewModal');
        const modal = new bootstrap.Modal(modalEl);

        document.getElementById('worldbankPreviewSpinner').classList.remove('d-none');
        document.getElementById('worldbankPreviewError').classList.add('d-none');
        document.getElementById('worldbankPreviewTable').style.display = 'none';
        document.getElementById('worldbankPreviewChart').style.display = 'none';
        document.getElementById('worldbankPreviewSvg').innerHTML = '';
        document.getElementById('worldbankPreviewTbody').innerHTML = '';
        document.getElementById('worldbankPreviewTitle').textContent = result.indicator || 'Data Preview';

        modal.show();

        try {
          const indicator = result.indicator_code || result.code || result.id || '';
          if (!indicator) throw new Error('Missing indicator code');

          const url = `/api/remote/worldbank/preview?indicator=${encodeURIComponent(indicator)}&limit=200`;
          const res = await fetch(url);
          const data = await res.json();
          if (data.status !== 'success') {
            throw new Error(data.message || 'Preview failed');
          }

          const rows = data.preview?.rows || [];
          const series = data.preview?.series || [];
          const tbody = document.getElementById('worldbankPreviewTbody');
          rows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${row.country || ''}</td>
              <td>${row.country_code || ''}</td>
              <td>${row.year || ''}</td>
              <td>${row.value ?? ''}</td>
            `;
            tbody.appendChild(tr);
          });

          if (series.length > 1) {
            this.renderMiniChart('worldbankPreviewSvg', series);
            document.getElementById('worldbankPreviewChart').style.display = 'block';
          }

          document.getElementById('worldbankPreviewSpinner').classList.add('d-none');
          document.getElementById('worldbankPreviewTable').style.display = 'block';
        } catch (err) {
          console.error('World Bank preview error', err);
          document.getElementById('worldbankPreviewSpinner').classList.add('d-none');
          const errEl = document.getElementById('worldbankPreviewError');
          errEl.querySelector('span').textContent = err.message || String(err);
          errEl.classList.remove('d-none');
        }
      },

      async previewOecd(result) {
        const modalEl = document.getElementById('oecdPreviewModal');
        const modal = new bootstrap.Modal(modalEl);

        document.getElementById('oecdPreviewSpinner').classList.remove('d-none');
        document.getElementById('oecdPreviewError').classList.add('d-none');
        document.getElementById('oecdPreviewTable').style.display = 'none';
        document.getElementById('oecdPreviewChart').style.display = 'none';
        document.getElementById('oecdPreviewSvg').innerHTML = '';
        document.getElementById('oecdPreviewTbody').innerHTML = '';
        document.getElementById('oecdPreviewTitle').textContent = result.indicator || result.id || 'Data Preview';

        modal.show();

        try {
          let dataset = result.dataset || '';
          let indicator = result.indicator_code || '';
          if (!dataset && result.code) {
            const parts = String(result.code).split('.', 2);
            dataset = parts[0] || '';
            indicator = indicator || parts[1] || '';
          }

          if (!dataset) throw new Error('Missing dataset id');

          const params = new URLSearchParams({ dataset });
          if (indicator) params.append('indicator', indicator);
          params.append('limit', '200');

          const url = `/api/remote/oecd/preview?${params.toString()}`;
          const res = await fetch(url);
          const data = await res.json();
          if (data.status !== 'success') {
            throw new Error(data.message || 'Preview failed');
          }

          const rows = data.preview?.rows || [];
          const series = data.preview?.series || [];
          const tbody = document.getElementById('oecdPreviewTbody');
          rows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${row.country || ''}</td>
              <td>${row.year || ''}</td>
              <td>${row.value ?? ''}</td>
            `;
            tbody.appendChild(tr);
          });

          if (series.length > 1) {
            this.renderMiniChart('oecdPreviewSvg', series);
            document.getElementById('oecdPreviewChart').style.display = 'block';
          }

          document.getElementById('oecdPreviewSpinner').classList.add('d-none');
          document.getElementById('oecdPreviewTable').style.display = 'block';
        } catch (err) {
          console.error('OECD preview error', err);
          document.getElementById('oecdPreviewSpinner').classList.add('d-none');
          const errEl = document.getElementById('oecdPreviewError');
          errEl.querySelector('span').textContent = err.message || String(err);
          errEl.classList.remove('d-none');
        }
      },

      async startDownload(result, options = {}) {
        console.log('=== DOWNLOAD STARTED ===');
        this.downloading = { ...this.downloading, [result.id]: true };
        this.downloadStatus = {
          ...this.downloadStatus,
          [result.id]: { status: 'in_progress' }
        };
        if (!options.silent) {
          this.error = '';
          this.successMessage = '';
        }

        try {
          const res = await fetch('/api/download/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: result.id,
              source: result.source.toLowerCase(),
              indicator: result.indicator,
              description: result.description,
              remote: result.remote || false,
              slug: result.slug,
                url: result.url,
                indicator_code: result.indicator_code,
                dataset: result.dataset,
                code: result.code,
                database: result.database,
                table: result.table
            })
          });

          let data;
          try {
            data = await res.json();
          } catch (parseErr) {
            const text = await res.text().catch(() => null);
            if (text) {
              this.error = text;
            } else {
              this.error = 'Invalid response from server';
            }
            return;
          }

          // Rely on consistent backend JSON: status = success|enqueued|already_queued|error
          if (data.status === 'success') {
            if (!options.silent) {
              this.successMessage = data.message || `OK: Download completed: ${result.indicator}`;
            }
            const resultIndex = this.results.findIndex(r => r.id === result.id);
            if (resultIndex !== -1) { this.results[resultIndex].downloaded = true; }
            this.downloadStatus = {
              ...this.downloadStatus,
              [result.id]: { status: 'success' }
            };
            if (!options.silent) {
              setTimeout(() => { this.successMessage = ''; }, 5000);
            }
          } else if (data.status === 'enqueued') {
            if (!options.silent) {
              this.successMessage = data.message || `OK: Download queued for "${result.indicator}".`;
              setTimeout(() => { this.successMessage = ''; }, 5000);
            }
            this.downloadStatus = {
              ...this.downloadStatus,
              [result.id]: { status: 'queued' }
            };
          } else if (data.status === 'already_queued') {
            if (!options.silent) {
              this.error = data.message || 'This indicator is already in the download queue.';
            }
            this.downloadStatus = {
              ...this.downloadStatus,
              [result.id]: { status: 'queued' }
            };
          } else {
            if (!options.silent) {
              this.error = data.message || data.error || `Unknown error (status: ${data.status})`;
            }
            this.downloadStatus = {
              ...this.downloadStatus,
              [result.id]: { status: 'error' }
            };
          }

        } catch (err) {
          if (!options.silent) {
            this.error = `Error starting download: ${err.message}`;
          }
          console.error('Download error:', err);
          this.downloadStatus = {
            ...this.downloadStatus,
            [result.id]: { status: 'error' }
          };
        } finally {
          this.downloading = { ...this.downloading, [result.id]: false };
        }
      },

      selectionKey(result) {
        return result.id || result.slug || result.indicator || '';
      },

      isSelected(result) {
        const key = this.selectionKey(result);
        return key ? this.selectedKeys.includes(key) : false;
      },

      toggleSelection(result) {
        const key = this.selectionKey(result);
        if (!key) return;
        if (this.selectedKeys.includes(key)) {
          this.selectedKeys = this.selectedKeys.filter(k => k !== key);
        } else {
          this.selectedKeys = [...this.selectedKeys, key];
        }
      },

      allSelected() {
        const selectable = this.results
          .map(r => this.selectionKey(r))
          .filter(key => key);
        return selectable.length > 0 && selectable.every(key => this.selectedKeys.includes(key));
      },

      toggleSelectAll() {
        if (this.allSelected()) {
          this.selectedKeys = [];
          return;
        }
        this.selectedKeys = this.results
          .map(r => this.selectionKey(r))
          .filter(key => key);
      },

      async downloadSelected() {
        if (this.selectedKeys.length === 0 || this.bulkDownloading) return;
        this.bulkDownloading = true;
        this.error = '';
        this.successMessage = '';

        const selected = this.results.filter(r => this.selectedKeys.includes(this.selectionKey(r)));
        const outcomes = await Promise.allSettled(
          selected.map(result => this.startDownload(result, { silent: true }))
        );

        this.bulkDownloading = false;
        const failures = outcomes.filter(o => o.status === 'rejected').length;
        if (failures > 0) {
          this.error = `Warning: ${failures} download(s) failed. Check row status.`;
        }
        this.successMessage = `OK: Download started for ${selected.length} indicator(s).`;
        setTimeout(() => { this.successMessage = ''; }, 5000);
      },

      statusLabel(state) {
        if (!state || !state.status) return '';
        if (state.status === 'in_progress') return 'Downloading';
        if (state.status === 'queued') return 'Queued';
        if (state.status === 'success') return 'Done';
        if (state.status === 'error') return 'Error';
        return '';
      },

      statusClass(state) {
        if (!state || !state.status) return 'badge-secondary';
        if (state.status === 'in_progress') return 'badge-info';
        if (state.status === 'queued') return 'badge-secondary';
        if (state.status === 'success') return 'badge-success';
        if (state.status === 'error') return 'bg-danger text-white';
        return 'badge-secondary';
      },

      openBrowseVersions(result) {
        // Prefer passing slug/id to browse local
        const identifier = result.slug || result.id || result.indicator;
        const source = (result.source || '').toLowerCase();
        // Open browse local with query params to show latest and prefill search
        const url = `/browse/local?q=${encodeURIComponent(identifier)}&latest=true&source=${encodeURIComponent(source)}`;
        window.location.href = url;
      },

      applyQuickFilter(type) {
        this.page = 1;
        if (type === 'latam') {
          this.query = "Argentina Chile Colombia Peru Mexico Brasil";
          this.source = "owid";
        } else if (type === 'oecd') {
          this.source = "oecd";
          this.query = "";
        } else if (type === 'g20') {
          this.query = "G20 GDP growth";
          this.source = "imf";
        } else if (type === 'inflation') {
          this.query = "inflation rate";
          this.source = "owid";
        } else if (type === 'poverty') {
          this.query = "poverty headcount";
          this.source = "owid";
        }
        this.performSearch();
      }
    };
  }
</script>
{% endblock %}