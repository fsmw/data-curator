{% extends "base.html" %}
{% block content %}
<div x-data="searchForm()">
  <div class="card p-3 mb-3">
    <div class="row g-2 align-items-center">
      <div class="col-md-8">
        <input
          x-model="query"
          class="form-control"
          id="search-query"
          placeholder="Buscar indicadores (ej: salarios, tax, inflation, poverty)"
          @keyup.enter="performSearch()"
        />
      </div>
      <div class="col-md-2">
        <select class="form-select" x-model="source">
          <option value="">Fuente</option>
          <option value="owid">Our World in Data</option>
          <option value="ilostat">ILOSTAT</option>
          <option value="oecd">OECD</option>
          <option value="imf">IMF</option>
          <option value="worldbank">World Bank</option>
          <option value="eclac">ECLAC</option>
        </select>
      </div>
      <div class="col-md-2 text-end">
        <button
          @click="performSearch()"
          class="btn btn-primary w-100"
          :disabled="loading"
        >
          <span x-show="!loading"><i class="ms-Icon ms-Icon--Search"></i> Buscar</span>
          <span x-show="loading" class="spinner-border spinner-border-sm me-2"></span>
        </button>
      </div>
    </div>
  </div>
  <div class="card p-3">
  <div class="text-secondary small mb-2">
    Resultados 
    <span x-show="query || source">
      para: <strong x-text="`${query}${source ? ' • ' + source : ''}`"></strong>
    </span>
  </div>
  <div x-show="successMessage" class="alert alert-success mb-3" role="alert">
    <i class="ms-Icon ms-Icon--CheckMark"></i>
    <span x-text="successMessage"></span>
  </div>
  <div x-show="error" class="alert alert-warning mb-3" role="alert">
    <i class="ms-Icon ms-Icon--Warning"></i>
    <span x-text="error"></span>
  </div>
  <table class="table table-hover align-middle mb-0">
    <thead>
      <tr><th>Indicador</th><th>Descripción</th><th>Fuente</th><th></th></tr>
    </thead>
    <tbody>
      <template x-for="result in results" :key="result.id">
        <tr>
          <td>
            <strong x-text="result.indicator"></strong>
            <div class="small text-secondary" x-show="result.tags">
              <i class="ms-Icon ms-Icon--Tag"></i> <span x-text="result.tags"></span>
            </div>
          </td>
          <td class="small text-secondary" x-text="result.description"></td>
          <td><span class="badge bg-primary" x-text="result.source"></span></td>
          <td class="text-end">
            <!-- Show badge if already downloaded -->
            <span x-show="result.downloaded" class="badge bg-success">
              <i class="ms-Icon ms-Icon--CheckMark"></i> Ya Descargado
            </span>
            
            <!-- Show download button if not downloaded -->
            <button 
              x-show="!result.downloaded"
              @click.prevent="startDownload(result)" 
              class="btn btn-outline-primary btn-sm"
              type="button"
              :disabled="downloading[result.id] === true"
              :class="{ 'disabled': downloading[result.id] === true }"
            >
              <span x-show="downloading[result.id] !== true">
                <i class="ms-Icon ms-Icon--Download"></i> Descargar
              </span>
              <span x-show="downloading[result.id] === true">
                <i class="ms-Icon ms-Icon--Sync"></i> Descargando...
              </span>
            </button>
          </td>
        </tr>
      </template>
      <tr x-show="results.length === 0 && !loading">
        <td colspan="4" class="text-center text-secondary py-4">
          <span x-show="!query && !source">Escribe algo para buscar...</span>
          <span x-show="(query || source) && results.length === 0">Sin resultados</span>
        </td>
      </tr>
    </tbody>
  </table>
  </div>
</div>

<script>
function searchForm() {
  return {
    query: '',
    source: '',
    results: [],
    loading: false,
    error: '',
    downloading: {},
    successMessage: '',
    async performSearch() {
      if (!this.query && !this.source) {
        this.results = [];
        return;
      }
      this.loading = true;
      this.error = '';
      this.successMessage = '';
      try {
        const params = new URLSearchParams();
        if (this.query) params.append('q', this.query);
        if (this.source) params.append('source', this.source);
        
        const res = await fetch(`/api/search?${params}`);
        if (!res.ok) throw new Error(`Error ${res.status}`);
        const data = await res.json();
        this.results = data.results || [];
      } catch (err) {
        this.error = `Búsqueda falló: ${err.message}`;
        this.results = [];
      } finally {
        this.loading = false;
      }
    },
    async startDownload(result) {
      console.log('=== DOWNLOAD STARTED ===');
      console.log('Result:', result);
      
      // Mark this indicator as downloading (create new object for reactivity)
      this.downloading = { ...this.downloading, [result.id]: true };
      this.error = '';
      this.successMessage = '';
      
      try {
        console.log('Sending POST to /api/download/start');
        
        const res = await fetch('/api/download/start', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            id: result.id,
            source: result.source.toLowerCase(),
            indicator: result.indicator,
            description: result.description
          })
        });
        
        console.log('Response status:', res.status);
        const data = await res.json();
        console.log('Response data:', data);
        
        if (!res.ok || data.status === 'error') {
          throw new Error(data.message || 'Download failed');
        }
        
        // Show success message
        this.successMessage = data.message;
        
        // Mark this indicator as downloaded in the results
        const resultIndex = this.results.findIndex(r => r.id === result.id);
        if (resultIndex !== -1) {
          this.results[resultIndex].downloaded = true;
        }
        
        // Show details if available
        if (data.details) {
          const details = data.details;
          const detailsMsg = `Archivo: ${details.output_file}\nFilas: ${details.rows}, Columnas: ${details.columns}\nPaíses: ${details.countries}`;
          console.log('Download completed:', detailsMsg);
        }
        
        // Auto-hide success message after 5 seconds
        setTimeout(() => {
          this.successMessage = '';
        }, 5000);
        
      } catch (err) {
        this.error = `Error descargando ${result.indicator}: ${err.message}`;
        console.error('Download error:', err);
      } finally {
        // Mark as not downloading (create new object for reactivity)
        this.downloading = { ...this.downloading, [result.id]: false };
      }
    }
  };
}
</script>
{% endblock %}
