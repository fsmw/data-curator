{% extends "base.html" %}
{% block content %}
<div x-data="copilotChat()" x-init="init()" class="h-100 d-flex flex-column">
  <!-- Header -->
  <div class="card mb-3">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-0">
          <i class="bi bi-robot text-primary"></i> 
          AI Data Assistant
          {% if not copilot_available %}
            <span class="badge bg-warning text-dark ms-2">Unavailable</span>
          {% endif %}
        </h5>
        <small class="text-secondary">Powered by GitHub Copilot SDK</small>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" @click="clearChat()" :disabled="messages.length === 0">
          <i class="bi bi-trash"></i> Clear
        </button>
        <button class="btn btn-outline-info btn-sm" @click="checkHealth()">
          <i class="bi bi-heart-pulse"></i> Health
        </button>
      </div>
    </div>
  </div>

  <!-- Not Available Warning -->
  <div x-show="!copilot_available" class="alert alert-warning mb-3">
    <i class="bi bi-exclamation-triangle"></i>
    <strong>GitHub Copilot SDK not available.</strong>
    Install with: <code>pip install github-copilot-sdk</code>
  </div>

  <!-- Health Status -->
  <div x-show="health_status" class="alert mb-3" :class="health_status?.status === 'healthy' ? 'alert-success' : 'alert-warning'">
    <div class="d-flex justify-content-between">
      <span>
        <i class="bi" :class="health_status?.status === 'healthy' ? 'bi-check-circle' : 'bi-exclamation-circle'"></i>
        Status: <strong x-text="health_status?.status"></strong>
      </span>
      <button class="btn-close" @click="health_status = null"></button>
    </div>
    <div x-show="health_status?.tools_registered" class="mt-2 small">
      Tools registered: <span x-text="health_status?.tools_registered"></span>
    </div>
  </div>

  <!-- Chat Messages -->
  <div class="card flex-grow-1 mb-3" style="overflow-y: auto; max-height: 60vh;">
    <div class="card-body" id="chat-messages">
      <!-- Welcome Message -->
      <div x-show="messages.length === 0" class="text-center text-secondary py-5">
        <i class="bi bi-robot fs-1"></i>
        <h6 class="mt-3">Welcome to AI Data Assistant</h6>
        <p class="small">
          I can help you explore datasets, analyze data, and download from OWID.<br>
          Try asking: "Show me GDP data for Brazil" or "What datasets do we have about health?"
        </p>
        <!-- Quick Actions -->
        <div class="mt-3 d-flex flex-wrap justify-content-center gap-2">
          <button class="btn btn-outline-primary btn-sm" @click="sendQuick('What datasets are available?')">
            List datasets
          </button>
          <button class="btn btn-outline-primary btn-sm" @click="sendQuick('Download GDP per capita for LATAM')">
            Get GDP data
          </button>
          <button class="btn btn-outline-primary btn-sm" @click="sendQuick('Analyze trends in population growth')">
            Analyze trends
          </button>
        </div>
      </div>

      <!-- Message List -->
      <template x-for="(msg, index) in messages" :key="index">
        <div class="mb-3" :class="msg.role === 'user' ? 'text-end' : ''">
          <div class="d-flex align-items-start gap-2" :class="msg.role === 'user' ? 'flex-row-reverse' : ''">
            <!-- Avatar -->
            <div class="flex-shrink-0">
              <span class="badge rounded-pill" :class="msg.role === 'user' ? 'bg-primary' : 'bg-success'">
                <i class="bi" :class="msg.role === 'user' ? 'bi-person' : 'bi-robot'"></i>
              </span>
            </div>
            
            <!-- Message Content -->
            <div class="flex-grow-1" style="max-width: 80%;">
              <div class="card" :class="msg.role === 'user' ? 'bg-primary text-white' : 'bg-light'">
                <div class="card-body py-2 px-3">
                  <!-- Loading Indicator -->
                  <div x-show="msg.loading" class="d-flex align-items-center gap-2">
                    <span class="spinner-border spinner-border-sm"></span>
                    <span>Thinking...</span>
                  </div>
                  
                  <!-- Message Text -->
                  <div x-show="!msg.loading" x-html="formatMessage(msg.content)"></div>
                  
                  <!-- Tool Calls -->
                  <div x-show="msg.tools && msg.tools.length > 0" class="mt-2 pt-2 border-top">
                    <small class="text-secondary">
                      <i class="bi bi-tools"></i> Tools used:
                    </small>
                    <div class="d-flex flex-wrap gap-1 mt-1">
                      <template x-for="tool in msg.tools" :key="tool">
                        <span class="badge bg-info text-dark" x-text="tool"></span>
                      </template>
                    </div>
                  </div>
                </div>
              </div>
              <small class="text-secondary" x-text="formatTime(msg.timestamp)"></small>
            </div>
          </div>
        </div>
      </template>
    </div>
  </div>

  <!-- Input Area -->
  <div class="card">
    <div class="card-body">
      <form @submit.prevent="sendMessage()">
        <div class="input-group">
          <input 
            type="text" 
            class="form-control" 
            placeholder="Ask about datasets, analysis, or download data..."
            x-model="inputMessage"
            :disabled="loading || !copilot_available"
            @keydown.enter="sendMessage()"
          >
          <button 
            class="btn btn-primary" 
            type="submit"
            :disabled="!inputMessage.trim() || loading || !copilot_available"
          >
            <span x-show="!loading">
              <i class="bi bi-send"></i> Send
            </span>
            <span x-show="loading" class="spinner-border spinner-border-sm"></span>
          </button>
        </div>
      </form>
      <small class="text-secondary mt-1 d-block">
        <i class="bi bi-info-circle"></i>
        Tip: Try "download gdp-per-capita for Brazil and Argentina"
      </small>
    </div>
  </div>
</div>

<script>
function copilotChat() {
  return {
    messages: [],
    inputMessage: '',
    loading: false,
    sessionId: null,
    copilot_available: {{ 'true' if copilot_available else 'false' }},
    health_status: null,
    
    init() {
      console.log('Copilot Chat initialized');
      // Check health on load
      if (this.copilot_available) {
        this.checkHealth();
      }
    },
    
    async sendMessage() {
      if (!this.inputMessage.trim() || this.loading) return;
      
      const userMessage = this.inputMessage.trim();
      this.inputMessage = '';
      
      // Add user message
      this.messages.push({
        role: 'user',
        content: userMessage,
        timestamp: new Date()
      });
      
      // Add loading assistant message
      const assistantIndex = this.messages.push({
        role: 'assistant',
        content: '',
        loading: true,
        timestamp: new Date()
      }) - 1;
      
      this.loading = true;
      
      try {
        const response = await fetch('/api/copilot/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: userMessage,
            session_id: this.sessionId,
            stream: false
          })
        });
        
        const data = await response.json();
        
        // Update assistant message
        this.messages[assistantIndex].loading = false;
        
        if (data.status === 'success') {
          this.messages[assistantIndex].content = data.text || data.response || 'No response';
          this.messages[assistantIndex].tools = data.tools_called || [];
          this.sessionId = data.session_id || this.sessionId;
        } else {
          this.messages[assistantIndex].content = `Error: ${data.error || 'Unknown error'}`;
          this.messages[assistantIndex].error = true;
        }
        
      } catch (error) {
        this.messages[assistantIndex].loading = false;
        this.messages[assistantIndex].content = `Error: ${error.message}`;
        this.messages[assistantIndex].error = true;
      } finally {
        this.loading = false;
        this.scrollToBottom();
      }
    },
    
    sendQuick(message) {
      this.inputMessage = message;
      this.sendMessage();
    },
    
    async checkHealth() {
      try {
        const response = await fetch('/api/copilot/health');
        this.health_status = await response.json();
      } catch (error) {
        this.health_status = { status: 'error', error: error.message };
      }
    },
    
    clearChat() {
      if (confirm('Clear all messages?')) {
        this.messages = [];
        this.sessionId = null;
      }
    },
    
    formatMessage(text) {
      if (!text) return '';
      // Convert newlines to <br>
      return text.replace(/\n/g, '<br>');
    },
    
    formatTime(date) {
      if (!date) return '';
      return new Date(date).toLocaleTimeString();
    },
    
    scrollToBottom() {
      setTimeout(() => {
        const container = document.getElementById('chat-messages');
        if (container) {
          container.scrollTop = container.scrollHeight;
        }
      }, 100);
    }
  }
}
</script>
{% endblock %}
