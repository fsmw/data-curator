{% extends "base.html" %}

{% block content %}
<div class="chat-container" x-data="chatApp()">
  <!-- Chat Messages Area -->
  <div class="chat-messages" id="chatMessages">
    <!-- Welcome Message -->
    <div class="message assistant-message" x-show="messages.length === 0">
      <div class="message-avatar">
        <i class="bi bi-robot"></i>
      </div>
      <div class="message-content">
        <div class="message-text">
          <h5>Hola! Soy tu asistente de datos económicos</h5>
          <p>Puedo ayudarte con:</p>
          <ul>
            <li>Buscar datasets en el catálogo local</li>
            <li>Buscar y descargar datos de fuentes externas (ILOSTAT, OECD, IMF, WorldBank, OWID)</li>
            <li>Analizar datasets existentes</li>
            <li>Responder preguntas sobre cobertura y calidad de datos</li>
          </ul>
          <p class="mb-0"><strong>Ejemplos de preguntas:</strong></p>
          <ul class="mb-0">
            <li>"¿Qué datasets tenemos sobre salarios reales?"</li>
            <li>"Busca datos sobre inflación en OWID"</li>
            <li>"Muéstrame los países disponibles en el dataset de informalidad laboral"</li>
            <li>"Descarga datos sobre libertad económica de WorldBank para Argentina"</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Chat Messages -->
    <template x-for="(msg, index) in messages" :key="index">
      <div :class="'message ' + (msg.role === 'user' ? 'user-message' : 'assistant-message')">
        <div class="message-avatar">
          <i :class="msg.role === 'user' ? 'bi bi-person-fill' : 'bi bi-robot'"></i>
        </div>
        <div class="message-content">
          <div class="message-text" x-html="formatMessage(msg.content)"></div>
          
          <!-- Show tool calls if any -->
          <template x-if="msg.tool_calls && msg.tool_calls.length > 0">
            <div class="tool-calls mt-2">
              <template x-for="(tool, idx) in msg.tool_calls" :key="idx">
                <div class="tool-call-badge">
                  <i class="bi bi-gear-fill"></i>
                  <span x-text="getToolLabel(tool.function)"></span>
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>
    </template>

    <!-- Loading Indicator -->
    <div class="message assistant-message" x-show="isLoading">
      <div class="message-avatar">
        <i class="bi bi-robot"></i>
      </div>
      <div class="message-content">
        <div class="typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Input Area -->
  <div class="chat-input-container">
    <form @submit.prevent="sendMessage" class="chat-input-form">
      <textarea
        x-model="inputMessage"
        @keydown.enter.prevent="if(!$event.shiftKey) sendMessage()"
        placeholder="Escribe tu pregunta aquí... (Shift+Enter para nueva línea)"
        rows="1"
        class="form-control chat-input"
        :disabled="isLoading"
      ></textarea>
      <button 
        type="submit" 
        class="btn btn-primary chat-send-btn"
        :disabled="!inputMessage.trim() || isLoading"
      >
        <i class="bi bi-send-fill"></i>
      </button>
    </form>
    <div class="text-muted small text-center mt-2">
      Powered by GPT-OSS via OpenRouter
    </div>
  </div>
</div>

<style>
.chat-container {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 180px);
  max-width: 900px;
  margin: 0 auto;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.message {
  display: flex;
  gap: 12px;
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.message-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 18px;
}

.user-message .message-avatar {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.assistant-message .message-avatar {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
}

.message-content {
  flex: 1;
  max-width: calc(100% - 48px);
}

.message-text {
  background: #2d3748;
  color: #ffffff;
  padding: 12px 16px;
  border-radius: 12px;
  line-height: 1.6;
}

.user-message .message-text {
  background: #667eea;
  color: white;
}

.assistant-message .message-text {
  background: #2d3748;
  color: #ffffff;
}

.message-text h5 {
  font-size: 1.1rem;
  margin-bottom: 0.5rem;
  color: #ffffff;
}

.message-text ul {
  margin-left: 20px;
  margin-bottom: 0.5rem;
}

.message-text p {
  color: #ffffff;
}

.message-text strong {
  color: #ffffff;
}

.message-text code {
  background: rgba(255,255,255,0.15);
  color: #a3d9ff;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.9em;
}

.message-text pre {
  background: rgba(0,0,0,0.3);
  color: #e2e8f0;
  padding: 10px;
  border-radius: 6px;
  overflow-x: auto;
  margin: 10px 0;
}

.user-message .message-text code,
.user-message .message-text pre {
  background: rgba(255,255,255,0.2);
  color: #ffffff;
}

.tool-calls {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.tool-call-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: #e7f3ff;
  color: #0066cc;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 500;
}

.tool-call-badge i {
  font-size: 0.9rem;
}

.typing-indicator {
  display: flex;
  gap: 4px;
  padding: 12px 16px;
}

.typing-indicator span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #999;
  animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
  30% { transform: translateY(-10px); opacity: 1; }
}

.chat-input-container {
  border-top: 1px solid #dee2e6;
  padding: 20px;
  background: white;
}

.chat-input-form {
  display: flex;
  gap: 12px;
  align-items: flex-end;
}

.chat-input {
  flex: 1;
  resize: none;
  min-height: 44px;
  max-height: 120px;
  border-radius: 12px;
  border: 2px solid #e9ecef;
  padding: 10px 14px;
  font-size: 0.95rem;
  transition: border-color 0.2s;
}

.chat-input:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
}

.chat-send-btn {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  transition: transform 0.2s, box-shadow 0.2s;
}

.chat-send-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.chat-send-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Scrollbar styling */
.chat-messages::-webkit-scrollbar {
  width: 8px;
}

.chat-messages::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.chat-messages::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 4px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
  background: #555;
}
</style>

<!-- Markdown renderer and sanitizer for chat messages -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

<script>
function chatApp() {
  return {
    messages: [],
    inputMessage: '',
    isLoading: false,
    conversationHistory: [],

    async sendMessage() {
      const message = this.inputMessage.trim();
      console.log('Attempting to send message:', message);
      console.log('Is loading:', this.isLoading);
      
      if (!message || this.isLoading) {
        console.log('Message blocked - empty or loading');
        return;
      }

      console.log('Sending message...');
      
      // Add user message to UI
      this.messages.push({
        role: 'user',
        content: message
      });

      // Clear input
      this.inputMessage = '';

      // Scroll to bottom
      this.$nextTick(() => this.scrollToBottom());

      // Set loading state
      this.isLoading = true;

      try {
        console.log('Calling API...');
        // Call API
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: message,
            conversation_history: this.conversationHistory
          })
        });

        console.log('Response received:', response.status);
        const data = await response.json();
        console.log('Data parsed:', data);

        if (data.status === 'success') {
          // Update conversation history
          this.conversationHistory = data.conversation_history;

          // Add assistant response to UI
          this.messages.push({
            role: 'assistant',
            content: data.response,
            tool_calls: data.tool_calls
          });

          // Scroll to bottom
          this.$nextTick(() => this.scrollToBottom());
        } else {
          // Show error
          this.messages.push({
            role: 'assistant',
            content: '❌ Error: ' + (data.message || 'Error desconocido')
          });
        }
      } catch (error) {
        console.error('Error sending message:', error);
        this.messages.push({
          role: 'assistant',
          content: '❌ Error al comunicarse con el servidor: ' + error.message
        });
      } finally {
        this.isLoading = false;
        this.$nextTick(() => this.scrollToBottom());
      }
    },

    scrollToBottom() {
      const messagesDiv = document.getElementById('chatMessages');
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    },

    formatMessage(content) {
      if (!content) return '';

      try {
        // Use marked to convert Markdown to HTML, then sanitize with DOMPurify
        const rawHtml = marked.parse(content);
        const cleanHtml = DOMPurify.sanitize(rawHtml);
        return cleanHtml;
      } catch (e) {
        // Fallback to simple replacements if marked fails
        let formatted = content
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
          .replace(/`([^`]+)`/g, '<code>$1</code>')
          .replace(/\n/g, '<br>');
        return formatted;
      }
    },

    getToolLabel(functionName) {
      const labels = {
        'search_local_datasets': 'Buscando en catálogo local',
        'search_external_sources': 'Buscando en fuentes externas',
        'download_dataset': 'Descargando dataset',
        'analyze_dataset': 'Analizando dataset',
        'list_datasets': 'Listando datasets'
      };
      return labels[functionName] || functionName;
    }
  };
}
</script>
{% endblock %}
