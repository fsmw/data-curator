{% extends "base.html" %}

{% block content %}
<div class="row g-4" x-data="compareApp()">

    <!-- Sidebar / Configuration -->
    <div class="col-lg-3">
        <div class="card shadow-sm border-0 sticky-top" style="top: 2rem;">
            <div class="card-body">
                <h5 class="card-title fw-bold mb-3">
                    <i class="bi bi-sliders me-2 text-primary"></i>Configuración
                </h5>

                <!-- Dataset Y Axis -->
                <div class="mb-4">
                    <label class="form-label small text-uppercase fw-bold text-muted">Eje Y (Vertical)</label>
                    <div class="d-grid gap-2">
                        <template x-if="datasetY">
                            <div
                                class="p-2 border rounded bg-light d-flex align-items-start justify-content-between w-100">
                                <div style="flex: 1; min-width: 0; word-wrap: break-word; overflow-wrap: break-word;">
                                    <div class="fw-bold small lh-sm" x-text="datasetY.indicator"></div>
                                    <div class="text-muted small mt-1" style="font-size: 0.75rem"
                                        x-text="datasetY.source"></div>
                                </div>
                                <button class="btn btn-sm btn-link text-danger p-0 ms-2"
                                    style="width: 20px; flex: 0 0 20px;" @click="removeDataset('y')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </template>
                        <button class="btn btn-outline-secondary btn-sm" @click="openSelector('y')" x-show="!datasetY">
                            <i class="bi bi-plus-lg me-1"></i> Seleccionar
                        </button>
                    </div>
                </div>

                <!-- Dataset X Axis -->
                <div class="mb-4">
                    <label class="form-label small text-uppercase fw-bold text-muted">Eje X (Horizontal)</label>
                    <div class="d-grid gap-2">
                        <template x-if="datasetX">
                            <div
                                class="p-2 border rounded bg-light d-flex align-items-start justify-content-between w-100">
                                <div style="flex: 1; min-width: 0; word-wrap: break-word; overflow-wrap: break-word;">
                                    <div class="fw-bold small lh-sm" x-text="datasetX.indicator"></div>
                                    <div class="text-muted small mt-1" style="font-size: 0.75rem"
                                        x-text="datasetX.source"></div>
                                </div>
                                <button class="btn btn-sm btn-link text-danger p-0 ms-2"
                                    style="width: 20px; flex: 0 0 20px;" @click="removeDataset('x')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </template>
                        <button class="btn btn-outline-secondary btn-sm" @click="openSelector('x')" x-show="!datasetX">
                            <i class="bi bi-plus-lg me-1"></i> Seleccionar
                        </button>
                    </div>
                </div>

                <hr>

                <!-- Year Slider -->
                <div class="mb-4" :class="{ 'opacity-50 pointer-events-none': !canVisualize }">
                    <label class="form-label small text-uppercase fw-bold text-muted d-flex justify-content-between">
                        <span>Año</span>
                        <span class="badge bg-primary rounded-pill" x-text="selectedYear"></span>
                    </label>
                    <input type="range" class="form-range" :min="commonYears.min" :max="commonYears.max"
                        x-model="selectedYear" @input="updateChart()" :disabled="!canVisualize">
                    <div class="d-flex justify-content-between text-muted small" style="font-size: 0.7rem;">
                        <span x-text="commonYears.min"></span>
                        <span x-text="commonYears.max"></span>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Main Content / Visualization -->
    <div class="col-lg-9">

        <!-- Empty State -->
        <div class="card shadow-sm border-0 h-100" x-show="!canVisualize">
            <div
                class="card-body d-flex flex-column justify-content-center align-items-center text-center p-5 text-muted">
                <div class="display-1 text-light mb-3">
                    <i class="bi bi-shuffle"></i>
                </div>
                <h3>Comparador de Datos</h3>
                <p class="mb-4 mw-500">
                    Seleccione dos datasets para analizar correlaciones. <br>
                    Descubra cómo interactúan diferentes variables económicas y sociales.
                </p>
                <div class="d-flex gap-3">
                    <button class="btn btn-primary" @click="openSelector('y')" :disabled="datasetY">
                        1. Elegir Variable Y
                    </button>
                    <button class="btn btn-outline-primary" @click="openSelector('x')" :disabled="datasetX">
                        2. Elegir Variable X
                    </button>
                </div>
            </div>
        </div>

        <!-- Visualization -->
        <div class="card shadow-sm border-0" x-show="canVisualize" style="display: none;">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="m-0 fw-bold text-gradient">
                    <i class="bi bi-graph-up-arrow me-2"></i>Análisis de Correlación
                </h5>
                <button class="btn btn-sm btn-outline-primary" @click="checkAndLoadData()">
                    <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
                </button>
            </div>

            <div class="card-body p-4">
                <!-- Correlation Analysis Status -->
                <div class="alert mb-4" :class="correlationQuality.class" role="alert" x-show="overlapStats">
                    <div class="d-flex align-items-center">
                        <div class="fs-4 me-3">
                            <i :class="correlationQuality.icon"></i>
                        </div>
                        <div>
                            <h6 class="alert-heading fw-bold mb-1" x-text="correlationQuality.title"></h6>
                            <p class="mb-0 small" x-text="correlationQuality.message"></p>
                        </div>
                    </div>
                </div>

                <div id="compare-chart" class="w-100" style="min-height: 500px;"></div>
            </div>
            <div class="card-footer bg-white border-top border-light p-3">
                <div class="d-flex align-items-center justify-content-between text-muted small">
                    <div>
                        <i class="bi bi-info-circle me-1"></i>
                        <span x-text="chartMessage">Mostrando correlación</span>
                    </div>
                    <span x-text="totalPoints + ' países'"></span>
                </div>
            </div>
        </div>

    </div>

    <!-- Dataset Selector Modal -->
    <div class="modal fade" id="selectorModal" tabindex="-1" aria-hidden="true" x-ref="modal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title">Seleccionar Dataset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0"
                            placeholder="Buscar indicador (ej. PIB, inflación...)" x-model="searchQuery"
                            @input.debounce.300ms="searchDatasets()">
                    </div>

                    <div class="list-group list-group-flush overflow-auto custom-scrollbar" style="max-height: 400px;">
                        <template x-for="dataset in searchResults" :key="dataset.id">
                            <button class="list-group-item list-group-item-action py-3" @click="selectDataset(dataset)">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-bold text-dark" x-text="dataset.indicator_name"></div>
                                        <div class="small text-muted mt-1">
                                            <span class="badge bg-light text-dark border me-1"
                                                x-text="dataset.source.toUpperCase()"></span>
                                            <span x-text="dataset.topic"></span>
                                        </div>
                                    </div>
                                    <i class="bi bi-chevron-right text-muted"></i>
                                </div>
                            </button>
                        </template>
                        <template x-if="searchResults.length === 0 && searchQuery">
                            <div class="text-center py-5 text-muted">
                                No se encontraron datasets descargados. <br>
                                <a href="/search" class="btn btn-sm btn-link">Ir a Búsqueda Global</a>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('compareApp', () => ({
            datasetX: null,
            datasetY: null,
            activeSelector: null, // 'x' or 'y'

            // Search
            searchQuery: '',
            searchResults: [],

            // Analysis Data
            rawData: [],
            overlapStats: null,

            // Controls
            selectedYear: 2020,
            commonYears: { min: 2000, max: 2023 },

            // Chart State
            chartMessage: '',
            totalPoints: 0,

            modal: null,

            get correlationQuality() {
                if (!this.overlapStats) return { class: 'd-none', icon: '', title: '', message: '' };

                const pts = this.overlapStats.total_points;
                const countries = this.overlapStats.common_countries;

                if (pts > 50 && countries > 10) {
                    return {
                        class: 'alert-success',
                        icon: 'bi bi-check-circle-fill text-success',
                        title: 'Alta Correlación Posible',
                        message: `Se encontraron ${pts} puntos de datos coincidentes en ${countries} países comunes. Análisis viable.`
                    };
                } else if (pts > 0) {
                    return {
                        class: 'alert-warning',
                        icon: 'bi bi-exclamation-circle-fill text-warning',
                        title: 'Correlación Limitada',
                        message: `Solo ${pts} puntos coincidentes en ${countries} países. El análisis puede ser poco representativo.`
                    };
                } else {
                    return {
                        class: 'alert-danger',
                        icon: 'bi bi-x-circle-fill text-danger',
                        title: 'Sin Correlación',
                        message: 'No existen datos coincidentes (mismo año y país) entre estos datasets.'
                    };
                }
            },

            init() {
                this.modal = new bootstrap.Modal(this.$refs.modal);
                this.searchDatasets(); // Pre-load some
            },

            get canVisualize() {
                return this.datasetX && this.datasetY;
            },

            openSelector(axis) {
                this.activeSelector = axis;
                this.searchQuery = '';
                this.searchDatasets();
                this.modal.show();
            },

            async searchDatasets() {
                try {
                    // Only search LOCAL datasets for now (downloaded ones)
                    const res = await fetch(`/api/datasets?q=${encodeURIComponent(this.searchQuery)}&limit=20`);
                    const data = await res.json();
                    if (data.status === 'success') {
                        this.searchResults = data.datasets;
                    }
                } catch (e) {
                    console.error("Search error", e);
                }
            },

            selectDataset(dataset) {
                const minified = {
                    id: dataset.id,
                    indicator: dataset.indicator_name,
                    source: dataset.source,
                    unit: dataset.unit || ''
                };

                if (this.activeSelector === 'x') {
                    this.datasetX = minified;
                } else {
                    this.datasetY = minified;
                }

                this.modal.hide();
                this.checkAndLoadData();
            },

            removeDataset(axis) {
                if (axis === 'x') this.datasetX = null;
                if (axis === 'y') this.datasetY = null;
                this.overlapStats = null;
                this.rawData = [];
            },

            async checkAndLoadData() {
                if (!this.canVisualize) return;

                // Reset state
                this.overlapStats = null;

                // Load comparison data
                try {
                    // Show loading state if needed
                    const res = await fetch(`/api/compare/data?dataset_id_x=${this.datasetX.id}&dataset_id_y=${this.datasetY.id}`);
                    const data = await res.json();

                    if (data.status === 'success') {
                        this.rawData = data.data;
                        this.commonYears = data.year_range;
                        this.overlapStats = data.overlap_stats || {
                            total_points: this.rawData.length,
                            common_countries: new Set(this.rawData.map(d => d.country)).size,
                            common_years: new Set(this.rawData.map(d => d.year)).size
                        };

                        if (this.rawData.length === 0) {
                            // Empty state handled by overlapStats computed property in UI
                            // Clear chart
                            document.getElementById('compare-chart').innerHTML = '';
                            return;
                        }

                        // Set default year to latest
                        if (this.selectedYear > this.commonYears.max) this.selectedYear = this.commonYears.max;
                        if (this.selectedYear < this.commonYears.min) this.selectedYear = this.commonYears.min;

                        this.updateChart();
                    } else {
                        alert('Error al cargar datos comparativos: ' + data.message);
                    }
                } catch (e) {
                    console.error("Load error", e);
                }
            },

            updateChart() {
                if (!this.rawData.length) return;

                // Filter by year
                const currentYearData = this.rawData.filter(d => d.year == this.selectedYear);
                this.totalPoints = currentYearData.length;
                this.chartMessage = `Datos del año ${this.selectedYear}`;

                if (this.totalPoints === 0) {
                    // Handle empty year
                    document.getElementById('compare-chart').innerHTML =
                        `<div class="d-flex align-items-center justify-content-center h-100 text-muted">Sin datos para ${this.selectedYear}</div>`;
                    return;
                }

                const spec = {
                    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                    "width": "container",
                    "height": 500,
                    "padding": 20,
                    "data": { "values": currentYearData },
                    "mark": {
                        "type": "point",
                        "filled": true,
                        "size": 100,
                        "stroke": "white",
                        "strokeWidth": 1,
                        "tooltip": true
                    },
                    "encoding": {
                        "x": {
                            "field": "val_x",
                            "type": "quantitative",
                            "title": this.datasetX.indicator,
                            "axis": { "grid": true }
                        },
                        "y": {
                            "field": "val_y",
                            "type": "quantitative",
                            "title": this.datasetY.indicator,
                            "axis": { "grid": true }
                        },
                        "color": {
                            "field": "country",
                            "type": "nominal",
                            "legend": null // Too many countries usually
                        },
                        "tooltip": [
                            { "field": "country", "type": "nominal", "title": "País" },
                            { "field": "val_x", "type": "quantitative", "title": this.datasetX.indicator, "format": ",.2f" },
                            { "field": "val_y", "type": "quantitative", "title": this.datasetY.indicator, "format": ",.2f" }
                        ]
                    },
                    "config": {
                        "view": { "stroke": "transparent" },
                        "axis": {
                            "domain": false,
                            "tickColor": "lightgray",
                            "labelColor": "#666",
                            "titleColor": "#333",
                            "titleFontWeight": "bold"
                        }
                    }
                };

                vegaEmbed('#compare-chart', spec, { actions: false });
            }

        }));
    });
</script>
{% endblock %}